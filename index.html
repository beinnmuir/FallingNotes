<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falling Notes</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
            background-color: #f0f8ff; /* AliceBlue - a light pastel */
            min-height: 100vh;
            cursor: crosshair;
            font-family: sans-serif;
            /* Remove flex layout for positioning zone labels */
            color: #b0c4de; /* LightSteelBlue */
            position: relative; /* Needed for absolute positioning of zones/labels */
        }

        .dot {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            pointer-events: none; /* Prevent dots from interfering with clicks */
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
            z-index: 10; /* Ensure dots are above zone dividers/labels */
        }

        /* Define some pastel colors */
        .pastel-pink { background-color: #ffb6c1; } /* LightPink */
        .pastel-blue { background-color: #add8e6; } /* LightBlue */
        .pastel-green { background-color: #98fb98; } /* PaleGreen */
        .pastel-yellow { background-color: #ffffe0; } /* LightYellow */
        .pastel-purple { background-color: #dda0dd; } /* Plum */

        #instructions {
            position: absolute;
            bottom: 10px;
            text-align: center;
            width: 100%;
            font-size: 0.9em;
            color: #a9a9a9; /* DarkGray */
            z-index: 1; /* Behind dots but above background */
        }

        /* Zone Styling */
        .zone-divider {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px; /* Horizontal line */
            background-color: rgba(176, 196, 222, 0.5); /* LightSteelBlue, semi-transparent */
            z-index: 0; /* Behind everything else */
        }

        .zone-label {
            position: absolute;
            left: 10px; /* Position from left edge */
            text-align: left;
            width: auto; /* Let content determine width */
            font-size: 0.8em;
            color: #b0c4de; /* LightSteelBlue */
            z-index: 1;
            pointer-events: none; /* Don't interfere with clicks */
            text-transform: capitalize;
        }

    </style>
</head>
<body>
    <!-- Zone dividers and labels will be added dynamically by JS -->
    <div id="instructions">Click (or click and drag) in different horizontal zones to change the scale. Left-to-right position determines the pitch.</div>

    <script>
        const body = document.body;
        let audioContext;
        const pastelColors = ['pastel-pink', 'pastel-blue', 'pastel-green', 'pastel-yellow', 'pastel-purple'];
        const activeDots = []; // Keep track of dots for animation
        let isDragging = false;
        let lastDragTime = 0;
        const dragThrottleInterval = 50; // Milliseconds between dot creation during drag

        // --- Musical Scales Definition ---
        const baseFrequency = 261.63; // C4
        const scales = {
            major:       { name: 'major', intervals: [0, 2, 4, 5, 7, 9, 11] },
            natMinor:    { name: 'natural minor', intervals: [0, 2, 3, 5, 7, 8, 10] },
            harMinor:    { name: 'harmonic minor', intervals: [0, 2, 3, 5, 7, 8, 11] },
            majPent:     { name: 'major pentatonic', intervals: [0, 2, 4, 7, 9] },
            chromatic:   { name: 'chromatic', intervals: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] } // Atonal-like
        };
        // Order can determine vertical position (top to bottom)
        const scaleOrder = ['major', 'majPent', 'natMinor', 'harMinor', 'chromatic'];
        const numZones = scaleOrder.length;
        let zoneHeight = window.innerHeight / numZones;

        // --- Sound Setup ---
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser", e);
                    alert("Sorry, your browser doesn't support the Web Audio API needed for sound.");
                }
            }
        }

        // --- Calculate Frequency from Scale Note ---
        function getFrequency(semitonesFromBase) {
            return baseFrequency * Math.pow(2, semitonesFromBase / 12);
        }

        // --- Play Note based on Scale and X-Position ---
        function playNote(xPosition, scale) { // Y position is implicit in the chosen scale
            if (!audioContext || !scale) return;

            // Normalize X across the entire screen width
            const relativeX = xPosition / window.innerWidth;

            const intervals = scale.intervals;
            // Map relativeX to an index in the scale's intervals array
            // Multiply by number of octaves desired across the screen width (e.g., 2)
            const octavesToSpan = 2;
            const totalNotesInSpan = intervals.length * octavesToSpan;
            const noteIndexOverall = Math.floor(relativeX * totalNotesInSpan);

            const noteIndexInScale = noteIndexOverall % intervals.length;
            const octaveShift = Math.floor(noteIndexOverall / intervals.length);

            const semitones = intervals[noteIndexInScale];
            const totalSemitones = semitones + (octaveShift * 12);

            const frequency = getFrequency(totalSemitones);

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime); // Slightly lower volume
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.75);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.8);
        }

        // --- Dot Creation ---
        function createDot(event) {
            initAudio();

            const dot = document.createElement('div');
            dot.classList.add('dot');
            const randomColorClass = pastelColors[Math.floor(Math.random() * pastelColors.length)];
            dot.classList.add(randomColorClass);

            const startX = event.clientX;
            const startY = event.clientY;
            dot.style.left = `${startX - 7}px`;
            dot.style.top = `${startY - 7}px`;

            body.appendChild(dot);

            // Determine scale based on vertical zone (Y position)
            const zoneIndex = Math.min(Math.floor(startY / zoneHeight), numZones - 1); // Ensure index is valid
            const scaleKey = scaleOrder[zoneIndex];
            const currentScale = scales[scaleKey];

            const dotInfo = {
                element: dot,
                x: startX,
                y: startY,
                vy: 1.5 + Math.random() * 1.5,
                scale: currentScale // Store the scale for this dot
            };
            activeDots.push(dotInfo);
        }

        // --- Animation Loop ---
        function animate() {
            const bottomBoundary = window.innerHeight;

            for (let i = activeDots.length - 1; i >= 0; i--) {
                const dotInfo = activeDots[i];
                dotInfo.vy += 0.1;
                dotInfo.y += dotInfo.vy;
                dotInfo.element.style.top = `${dotInfo.y - 7}px`;

                if (dotInfo.y + 7.5 >= bottomBoundary) {
                    playNote(dotInfo.x, dotInfo.scale); // Pass X pos and scale info
                    body.removeChild(dotInfo.element);
                    activeDots.splice(i, 1);
                }
            }
            requestAnimationFrame(animate);
        }

        // --- UI Setup (Dividers and Labels) ---
        function setupZones() {
            document.querySelectorAll('.zone-divider, .zone-label').forEach(el => el.remove());

            zoneHeight = window.innerHeight / numZones;

            for (let i = 1; i < numZones; i++) {
                // Add Horizontal Dividers
                const divider = document.createElement('div');
                divider.classList.add('zone-divider');
                divider.style.top = `${i * zoneHeight}px`; // Position based on height
                body.appendChild(divider);
            }

            for (let i = 0; i < numZones; i++) {
                // Add Labels (positioned vertically)
                const label = document.createElement('div');
                label.classList.add('zone-label');
                label.textContent = scales[scaleOrder[i]].name;
                // Center label vertically within its zone
                const labelY = (i * zoneHeight) + (zoneHeight / 2);
                label.style.top = `${labelY}px`;
                // Adjust for label height to truly center it
                label.style.transform = 'translateY(-50%)';
                body.appendChild(label);
            }
        }

        // --- Event Listeners ---
        body.addEventListener('click', (event) => {
             if (!isDragging) { createDot(event); }
        });
        body.addEventListener('mousedown', (event) => {
            isDragging = true;
            initAudio();
        });
        body.addEventListener('mousemove', (event) => {
            if (isDragging) {
                const now = Date.now();
                if (now - lastDragTime > dragThrottleInterval) {
                    createDot(event);
                    lastDragTime = now;
                }
            }
        });
        body.addEventListener('mouseup', () => {
            isDragging = false;
        });
        body.addEventListener('selectstart', (event) => {
            event.preventDefault();
        });

        // Handle window resize
        window.addEventListener('resize', setupZones);

        // Initial Setup
        setupZones();
        requestAnimationFrame(animate);

    </script>
</body>
</html>
